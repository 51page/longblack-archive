<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LongBlack Archive - Mobile Tactile Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Observer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@700;800&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000; --accent: #FF4E00;
            --tile-w: 240px; --tile-h: 340px; /* 모바일에서 잘 보이도록 크게 설정 */
            --nav-h: 80px;
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg); color: #fff;
            font-family: 'Montserrat', sans-serif; overflow: hidden; touch-action: none;
        }

        /* 상단 카테고리 (가로 스크롤 강화) */
        #category-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--nav-h);
            display: flex; align-items: center; gap: 20px; padding: 0 20px; z-index: 1000;
            background: linear-gradient(to bottom, #000 70%, transparent);
            overflow-x: auto; scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        #category-nav::-webkit-scrollbar { display: none; }
        .nav-item {
            font-size: 0.85rem; font-weight: 900; color: #444;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s; white-space: nowrap; flex-shrink: 0;
        }
        .nav-item.active { color: var(--accent); transform: scale(1.1); }

        /* 배경 흐르는 모드 컨테이너 */
        #bg-flow {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center;
            gap: 10px; opacity: 1; transition: opacity 0.5s;
        }
        .flow-row { display: flex; gap: 10px; width: max-content; }
        .flow-tile { width: 80px; height: 110px; border-radius: 4px; overflow: hidden; opacity: 0.3; filter: grayscale(1); }
        .flow-tile img { width: 100%; height: 100%; object-fit: cover; }

        /* 필터링된 카드 스택 (모바일 전용) */
        #stack-container {
            position: absolute; top: 55%; left: 50%;
            transform: translate(-50%, -50%);
            width: var(--tile-w); height: var(--tile-h);
            z-index: 100; display: none;
        }
        .stack-card {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: #111; border-radius: 12px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            will-change: transform, opacity;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stack-card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card-info {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px; box-sizing: border-box;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }
        .card-title { font-size: 0.9rem; font-weight: 700; margin: 0; line-height: 1.4; }

        /* 하이라이트 상세 팝업 */
        #focus-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); backdrop-filter: blur(25px);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; opacity: 0; pointer-events: none; transition: 0.4s;
        }
        #focus-overlay.active { opacity: 1; pointer-events: auto; }
        .focus-content { width: 85%; text-align: center; }
        .focus-img { width: 100%; max-height: 35vh; border-radius: 10px; object-fit: contain; margin-bottom: 20px; }
        .view-btn { display: inline-block; padding: 14px 40px; background: var(--accent); color: #fff; text-decoration: none; font-size: 0.8rem; font-weight: 800; border-radius: 50px; }
    </style>
</head>
<body style="opacity: 0; transition: 1s;">

    <nav id="category-nav">
        <span class="nav-item active" data-cat="all">All (Loading...)</span>
        <span class="nav-item" data-cat="브랜딩">Branding</span>
        <span class="nav-item" data-cat="사업기획">Business</span>
        <span class="nav-item" data-cat="디자인">Design</span>
        <span class="nav-item" data-cat="자기계발">Growth</span>
        <span class="nav-item" data-cat="테크">Tech</span>
        <span class="nav-item" data-cat="책리뷰">Book</span>
    </nav>

    <div id="bg-flow"></div>

    <div id="stack-container"></div>

    <div id="focus-overlay">
        <div class="focus-content">
            <img id="focus-img" src="" class="focus-img">
            <p id="focus-quote" style="font-family:'Nanum Myeongjo'; font-size:1.1rem; line-height:1.6; margin-bottom:15px;"></p>
            <h3 id="focus-title" style="font-size:0.8rem; opacity:0.6; margin-bottom:30px;"></h3>
            <a id="focus-link" href="https://www.longblack.co/" target="_blank" class="view-btn">READ NOTE</a>
            <p onclick="document.getElementById('focus-overlay').classList.remove('active')" style="margin-top:30px; font-size:0.6rem; opacity:0.3; letter-spacing:2px;">CLOSE</p>
        </div>
    </div>

    <script>
        let noteData = [];
        const bgFlow = document.getElementById('bg-flow');
        const stackContainer = document.getElementById('stack-container');
        const overlay = document.getElementById('focus-overlay');
        let timelines = [];
        let currentStackData = [];
        let stackIdx = 0;

        function autoTag(title) {
            if(/디자인|공간/.test(title)) return "디자인";
            if(/브랜드|마케팅/.test(title)) return "브랜딩";
            if(/비즈니스|전략/.test(title)) return "사업기획";
            if(/기록|성장/.test(title)) return "자기계발";
            if(/책|리뷰/.test(title)) return "책리뷰";
            return "테크";
        }

        function loadCSV() {
            Papa.parse("notedata.csv", {
                download: true, header: true,
                complete: function(results) {
                    noteData = results.data.filter(row => row.note_title).map(row => ({
                        ...row, category: autoTag(row.note_title)
                    }));
                    document.querySelector('[data-cat="all"]').innerText = `All (${noteData.length})`;
                    initBackgroundFlow();
                    gsap.to("body", {opacity: 1, duration: 1});
                }
            });
        }

        // 1. 전체 보기 (배경 흐름)
        function initBackgroundFlow() {
            bgFlow.innerHTML = ''; timelines.length = 0;
            const rowCount = 8;
            for (let r = 0; r < rowCount; r++) {
                const row = document.createElement('div');
                row.className = 'flow-row';
                for (let i = 0; i < 15; i++) {
                    const data = noteData[(r * 15 + i) % noteData.length];
                    row.innerHTML += `<div class="flow-tile"><img src="${data.thumbnail_url}"></div>`;
                }
                bgFlow.appendChild(row);
                const tl = gsap.to(row, { x: r % 2 === 0 ? "-30%" : "0%", duration: 30 + r*5, ease: "none", repeat: -1 });
                if(r % 2 !== 0) gsap.set(row, {x: "-30%"});
                timelines.push(tl);
            }
        }

        // 2. 카테고리 클릭 시: 벗겨내는 카드 스택으로 전환
        function filterMode(category) {
            if (category === 'all') {
                gsap.to(bgFlow, { opacity: 1, duration: 0.5 });
                stackContainer.style.display = 'none';
                timelines.forEach(tl => tl.play());
                return;
            }

            timelines.forEach(tl => tl.pause());
            gsap.to(bgFlow, { opacity: 0.1, duration: 0.5 });
            
            stackContainer.innerHTML = '';
            stackContainer.style.display = 'block';
            currentStackData = noteData.filter(d => d.category === category).slice(0, 15); // 최대 15장
            stackIdx = 0;

            currentStackData.reverse().forEach((data, i) => {
                const card = document.createElement('div');
                card.className = 'stack-card';
                card.innerHTML = `
                    <img src="${data.thumbnail_url}">
                    <div class="card-info"><p class="card-title">${data.note_title}</p></div>
                `;
                card.onclick = () => showFocus(data);
                stackContainer.appendChild(card);
                
                // 초기 스택 쌓기 애니메이션
                gsap.from(card, {
                    y: 500, rotation: 10, opacity: 0, 
                    duration: 0.6, delay: i * 0.05, ease: "back.out(1.7)"
                });
            });
        }

        // 3. 카드 벗겨내기 (Swipe Up 액션)
        function peelOff() {
            const cards = stackContainer.querySelectorAll('.stack-card');
            if (cards.length === 0) return;
            
            const topCard = cards[cards.length - 1]; // 가장 위에 있는 카드
            gsap.to(topCard, {
                y: -800, rotation: -20, opacity: 0, 
                duration: 0.7, ease: "power4.in",
                onComplete: () => topCard.remove()
            });
        }

        // 4. 터치 제어 (Observer)
        gsap.registerPlugin(Observer);
        Observer.create({
            target: window, type: "wheel,touch,pointer",
            onChange: (self) => {
                if (stackContainer.style.display === 'block' && self.deltaY > 5) {
                    peelOff(); // 아래로 스크롤/스와이프 하면 위로 벗겨내기
                }
            }
        });

        function showFocus(data) {
            document.getElementById('focus-img').src = data.thumbnail_url;
            document.getElementById('focus-quote').innerText = "“이 통찰이 당신의 감각을 깨우길 바랍니다.”";
            document.getElementById('focus-title').innerText = data.note_title;
            overlay.classList.add('active');
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.onclick = () => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                filterMode(item.dataset.cat);
            };
        });

        loadCSV();
    </script>
</body>
</html>
